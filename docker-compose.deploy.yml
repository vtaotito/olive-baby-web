version: '3.8'

services:
  # ==========================================
  # Frontend React + Vite (Build e Serve)
  # ==========================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_API_URL: https://oliecare.cloud/api/v1
    container_name: olivebaby-web-app
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - olivebaby-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # Nginx Reverse Proxy + SSL
  # ==========================================
  nginx:
    image: nginx:alpine
    container_name: olivebaby-nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ssl_certs:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot
    networks:
      - olivebaby-network
    depends_on:
      - web
    command: >
      /bin/sh -c "
      echo 'Creating Nginx configuration...' &&
      cat > /etc/nginx/conf.d/default.conf << 'EOF'
      server {
          listen 80 default_server;
          server_name oliecare.cloud www.oliecare.cloud _;
          
          location /.well-known/acme-challenge/ {
              root /var/www/certbot;
          }
          
          location /api/ {
              proxy_pass http://olivebaby-api:4000/api/;
              proxy_http_version 1.1;
              proxy_set_header Host \$$host;
              proxy_set_header X-Real-IP \$$remote_addr;
              proxy_set_header X-Forwarded-For \$$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto \$$scheme;
              proxy_read_timeout 90s;
          }
          
          location / {
              proxy_pass http://web:80;
              proxy_http_version 1.1;
              proxy_set_header Host \$$host;
              proxy_set_header X-Real-IP \$$remote_addr;
              proxy_set_header X-Forwarded-For \$$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto \$$scheme;
          }
      }
      
      server {
          listen 443 ssl http2;
          server_name oliecare.cloud www.oliecare.cloud;
          
          ssl_certificate /etc/letsencrypt/live/oliecare.cloud/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/oliecare.cloud/privkey.pem;
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_ciphers HIGH:!aNULL:!MD5;
          ssl_prefer_server_ciphers on;
          
          gzip on;
          gzip_vary on;
          gzip_types text/plain text/css application/json application/javascript application/xml;
          
          location /.well-known/acme-challenge/ {
              root /var/www/certbot;
          }
          
          location /api/ {
              proxy_pass http://olivebaby-api:4000/api/;
              proxy_http_version 1.1;
              proxy_set_header Host \$$host;
              proxy_set_header X-Real-IP \$$remote_addr;
              proxy_set_header X-Forwarded-For \$$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto https;
              proxy_read_timeout 90s;
          }
          
          location / {
              proxy_pass http://web:80;
              proxy_http_version 1.1;
              proxy_set_header Host \$$host;
              proxy_set_header X-Real-IP \$$remote_addr;
              proxy_set_header X-Forwarded-For \$$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto https;
          }
          
          add_header Strict-Transport-Security \"max-age=31536000\" always;
          add_header X-Frame-Options \"SAMEORIGIN\" always;
          add_header X-Content-Type-Options \"nosniff\" always;
      }
      EOF
      echo 'Starting Nginx...' &&
      nginx -g 'daemon off;'
      "
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Certbot para SSL
  # ==========================================
  certbot:
    image: certbot/certbot
    container_name: olivebaby-certbot
    volumes:
      - ssl_certs:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    networks:
      - olivebaby-network
    depends_on:
      - nginx
    entrypoint: /bin/sh
    command: >
      -c "
      echo 'Waiting for Nginx to start...' &&
      sleep 30 &&
      if [ ! -f /etc/letsencrypt/live/oliecare.cloud/fullchain.pem ]; then
        echo 'Obtaining SSL certificate...' &&
        certbot certonly --webroot --webroot-path=/var/www/certbot \
          --email vitor@titotech.com.br --agree-tos --no-eff-email \
          -d oliecare.cloud -d www.oliecare.cloud || echo 'Certificate already exists'
      fi &&
      echo 'Starting renewal loop...' &&
      while true; do
        sleep 12h;
        certbot renew --quiet;
      done
      "

volumes:
  ssl_certs:
  certbot_www:

networks:
  olivebaby-network:
    external: true
